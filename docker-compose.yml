# Docker Compose for ARM64 Ampere VPS - Production Ready
version: '3.8'

services:
  captcha-api:
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/arm64
    container_name: captcha-solver-api
    platform: linux/arm64
    ports:
      - "8000:8000"
    volumes:
      - ./temp_results:/app/temp_results
      - ./best.pt:/app/best.pt:ro  # Read-only for security
      - ./models:/app/models
      - ./database:/app/database
    environment:
      - MODEL_PATH=/app/best.pt
      - TEMP_RESULTS_DIR=/app/temp_results
      - OMP_NUM_THREADS=${OMP_NUM_THREADS:-4}
      - OPENBLAS_NUM_THREADS=${OPENBLAS_NUM_THREADS:-4}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT:-2.0}'
          memory: ${MEMORY_LIMIT:-2G}
        reservations:
          cpus: '${CPU_RESERVE:-1.0}'
          memory: ${MEMORY_RESERVE:-1G}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    networks:
      - captcha-network

  web-dashboard:
    image: nginx:alpine
    container_name: captcha-solver-dashboard
    platform: linux/arm64
    ports:
      - "3000:80"
    volumes:
      - ./web:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      captcha-api:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - captcha-network

networks:
  captcha-network:
    driver: bridge
    name: captcha-network
